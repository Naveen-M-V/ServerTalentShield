========================================
HRMS DETAILED DIAGNOSTIC
Generated: Sat Dec  6 11:54:12 AM UTC 2025
========================================

=== Backend Directory Structure ===
total 288K
drwxrwxr-x  12 pentest pentest 4.0K Dec  6 07:30 .
drwxrwxr-x   5 pentest pentest 4.0K Dec  6 11:54 ..
drwxrwxr-x   2 pentest pentest 4.0K Nov 28 10:44 config
drwxrwxr-x   2 pentest pentest 4.0K Dec  6 07:30 controllers
-rw-rw-r--   1 pentest pentest  204 Nov 28 10:38 ecosystem.config.js
-rw-rw-r--   1 pentest pentest 1.7K Nov 28 12:49 .env
-rw-rw-r--   1 pentest pentest  856 Nov 28 11:26 .env.production
-rw-rw-r--   1 pentest pentest  855 Nov 28 11:26 .env.production.backup
drwxrwxr-x   2 pentest pentest 4.0K Nov 28 12:26 middleware
drwxrwxr-x   2 pentest pentest 4.0K Dec  6 11:15 models
drwxrwxr-x 135 pentest pentest 4.0K Nov 27 09:33 node_modules
-rw-rw-r--   1 pentest pentest  805 Dec  3 05:13 package.json
-rw-rw-r--   1 pentest pentest  73K Nov 27 12:09 package-lock.json
drwxrwxr-x   3 pentest pentest 4.0K Nov 28 10:38 public
drwxrwxr-x   2 pentest pentest 4.0K Dec  6 11:15 routes
drwxrwxr-x   2 pentest pentest 4.0K Dec  6 06:17 scripts
-rw-rw-r--   1 pentest pentest 142K Dec  6 07:30 server.js
drwxrwxr-x   3 pentest pentest 4.0K Dec  6 07:51 uploads
drwxrwxr-x   2 pentest pentest 4.0K Dec  2 19:03 utils

=== Middleware Directory ===
total 12K
drwxrwxr-x  2 pentest pentest 4.0K Nov 28 12:26 .
drwxrwxr-x 12 pentest pentest 4.0K Dec  6 07:30 ..
-rw-rw-r--  1 pentest pentest 1.9K Nov 28 12:31 auth.js

Middleware files:
/home/pentest/apps/hrms/backend/middleware/auth.js

=== Auth Middleware Content ===
âœ“ auth.js EXISTS

const jwt = require('jsonwebtoken');
const User = require('../models/User');

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

const authenticateSession = async (req, res, next) => {
  try {
    // First check session
    if (req.session && req.session.user) {
      req.user = req.session.user;
      return next();
    }

    // Then check JWT token
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
      return res.status(401).json({ 
        success: false,
        message: 'Authentication required' 
      });
    }

    try {
      const decoded = jwt.verify(token, JWT_SECRET);
      
      // Find user in database
      const user = await User.findById(decoded.userId || decoded.id);
      
      if (!user) {
        return res.status(401).json({
          success: false,
          message: 'User not found'
        });
      }

      req.user = {
        _id: user._id,
        userId: user._id,
        id: user._id,
        email: user.email,
        firstName: user.firstName,
        lastName: user.lastName,
        role: user.role
      };
      
      // Update session with token data
      req.session.user = req.user;
      return next();
    } catch (tokenError) {
      return res.status(403).json({ 
        success: false,
        message: 'Invalid or expired token' 
      });
    }
  } catch (error) {
    console.error('Authentication error:', error);
    return res.status(500).json({ 
      success: false,
      message: 'Internal server error during authentication' 
    });
  }
};

const authenticateToken = authenticateSession;

// Async handler wrapper
const asyncHandler = (fn) => (req, res, next) => {
  Promise.resolve(fn(req, res, next)).catch(next);
};

module.exports = { 
  authenticateSession, 
  authenticateToken,
  asyncHandler
};

=== Routes Directory ===
total 180K
drwxrwxr-x  2 pentest pentest 4.0K Dec  6 11:15 .
drwxrwxr-x 12 pentest pentest 4.0K Dec  6 07:30 ..
-rw-rw-r--  1 pentest pentest  903 Nov 28 10:38 auth.js
-rw-rw-r--  1 pentest pentest 4.0K Nov 27 09:33 bulkJobRoles.js
-rw-rw-r--  1 pentest pentest 7.6K Nov 27 09:33 certificates.js
-rw-rw-r--  1 pentest pentest  67K Dec  3 13:11 clockRoutes.js
-rw-rw-r--  1 pentest pentest  18K Dec  6 11:15 documentManagement.js
-rw-rw-r--  1 pentest pentest 1.6K Dec  3 13:11 employeeHubRoutes.js
-rw-rw-r--  1 pentest pentest 5.9K Dec  3 07:21 employeeProfile.js
-rw-rw-r--  1 pentest pentest 4.4K Nov 27 09:33 jobLevels.js
-rw-rw-r--  1 pentest pentest 2.4K Nov 27 09:33 jobRoles.js
-rw-rw-r--  1 pentest pentest  20K Dec  3 07:09 leaveRoutes.js
-rw-rw-r--  1 pentest pentest 4.7K Nov 27 09:33 notifications.js
-rw-rw-r--  1 pentest pentest 1.1K Dec  2 19:03 reportingRoutes.js
-rw-rw-r--  1 pentest pentest 1.4K Nov 28 10:38 rotaRoutes.js
-rw-rw-r--  1 pentest pentest  585 Nov 27 09:33 teamRoutes.js
-rw-rw-r--  1 pentest pentest 1.4K Nov 29 09:17 testRoutes.js

=== clockRoutes.js (first 50 lines) ===
const express = require('express');
const router = express.Router();
const moment = require('moment-timezone');
const TimeEntry = require('../models/TimeEntry');
const User = require('../models/User');
const EmployeesHub = require('../models/EmployeesHub');
const LeaveRecord = require('../models/LeaveRecord');
const AnnualLeaveBalance = require('../models/AnnualLeaveBalance');
const {
  findMatchingShift,
  validateClockIn,
  calculateHoursWorked,
  calculateScheduledHours,
  updateShiftStatus
} = require('../utils/shiftTimeLinker');
const crypto = require('crypto');

// Import asyncHandler from server.js
const { asyncHandler } = require('../middleware/auth');

// Import authentication middleware
const { authenticateSession } = require('../middleware/auth');

/**
 * Clock Routes
 * Handles time tracking and attendance functionality
 * Integrated with leave management system
 */

/**
 * Reverse Geocoding Helper Function
 * Converts GPS coordinates to human-readable address using OpenStreetMap Nominatim API
 * @param {Number} latitude - GPS latitude
 * @param {Number} longitude - GPS longitude
 * @returns {Promise<String>} - Formatted address or null if failed
 */
async function reverseGeocode(latitude, longitude) {
  try {
    const https = require('https');
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;
    
    return new Promise((resolve, reject) => {
      https.get(url, {
        headers: {
          'User-Agent': 'HRMS-App/1.0' // Required by OpenStreetMap
        }
      }, (response) => {
        let data = '';
        
        response.on('data', (chunk) => {

=== All Subdirectories ===
/home/pentest/apps/hrms/backend
/home/pentest/apps/hrms/backend/config
/home/pentest/apps/hrms/backend/controllers
/home/pentest/apps/hrms/backend/middleware
/home/pentest/apps/hrms/backend/models
/home/pentest/apps/hrms/backend/node_modules
/home/pentest/apps/hrms/backend/public
/home/pentest/apps/hrms/backend/public/static
/home/pentest/apps/hrms/backend/routes
/home/pentest/apps/hrms/backend/scripts
/home/pentest/apps/hrms/backend/uploads
/home/pentest/apps/hrms/backend/uploads/documents
/home/pentest/apps/hrms/backend/utils

=== Package.json ===
{
  "name": "hrms-backend",
  "version": "1.0.0",
  "description": "HRMS Backend API",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "check-expiring-docs": "node scripts/documentExpiryChecker.js",
    "init-leave-balances": "node scripts/initializeLeaveBalances.js"
  },
  "dependencies": {
    "bcrypt": "^6.0.0",
    "connect-mongo": "^5.1.0",
    "cookie-parser": "^1.4.6",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "express-session": "^1.17.3",
    "jsonwebtoken": "^9.0.2",
    "moment-timezone": "^0.6.0",
    "mongoose": "^8.20.1",
    "multer": "^1.4.5-lts.1",
    "node-cron": "^4.2.1",
    "nodemailer": "^7.0.6"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}

=== Environment Files ===
-rw-rw-r-- 1 pentest pentest 1.7K Nov 28 12:49 /home/pentest/apps/hrms/backend/.env
-rw-rw-r-- 1 pentest pentest  856 Nov 28 11:26 /home/pentest/apps/hrms/backend/.env.production
-rw-rw-r-- 1 pentest pentest  855 Nov 28 11:26 /home/pentest/apps/hrms/backend/.env.production.backup

Environment variable keys:
PORT
NODE_ENV
MONGODB_URI
JWT_SECRET
JWT_EXPIRES_IN
SESSION_SECRET
EMAIL_HOST
EMAIL_PORT
EMAIL_SECURE
EMAIL_USER
EMAIL_PASS
EMAIL_FROM
SUPER_ADMIN_EMAIL
FRONTEND_URL
BACKEND_URL
API_PUBLIC_URL
CORS_ORIGIN

=== Server.js (first 100 lines) ===
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const nodemailer = require('nodemailer');
const cron = require('node-cron');
const crypto = require('crypto');
const session = require('express-session');
const MongoStore = require('connect-mongo');
const cookieParser = require('cookie-parser');

// Global Async Error Handler Wrapper
const asyncHandler = (fn) => (req, res, next) => {
  Promise.resolve(fn(req, res, next)).catch(next);
};

// Export asyncHandler for use in routes
module.exports.asyncHandler = asyncHandler;

// Load environment configuration
const envConfig = require('./config/environment');
const config = envConfig.getConfig();
// Load utilities
const { generateSimplePassword } = require('./utils/passwordGenerator');
const { 
  sendLoginSuccessEmail, 
  sendCertificateExpiredEmail, 
  sendNotificationEmail, 
  testEmailConfiguration,
  sendTestEmail,
  sendVerificationEmail, 
  sendAdminApprovalRequestEmail, 
  sendUserCredentialsEmail, 
  sendAdminNewUserCredentialsEmail, 
  sendWelcomeEmailToNewUser
} = require('./utils/emailService');
const { startCertificateMonitoring, triggerCertificateCheck } = require('./utils/certificateMonitor');
const { startAllCertificateSchedulers } = require('./utils/certificateScheduler');
const { 
  notifyUserCreation,
  notifyProfileUpdate,
  notifyCertificateAdded,
  notifyCertificateDeleted,
  notifyCertificateUpdated
} = require('./utils/notificationService');

const app = express();
const PORT = config.server.port;
const JWT_SECRET = config.jwt.secret;
const MONGODB_URI = config.database.uri;

// Middleware
app.use(cookieParser());

// Session middleware configuration
app.use(session({
  secret: process.env.SESSION_SECRET || JWT_SECRET,
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({
    mongoUrl: MONGODB_URI,
    touchAfter: 24 * 3600, // Lazy session update
    ttl: 14 * 24 * 60 * 60, // 14 days
    autoRemove: 'native'
  }),
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    maxAge: 14 * 24 * 60 * 60 * 1000, // 14 days
    sameSite: process.env.NODE_ENV === 'production' ? 'lax' : 'lax',
    // Remove domain restriction to allow same-origin cookies
    domain: undefined
  },
  name: 'talentshield.sid' // Custom session name
}));

// CORS configuration
console.log(' CORS Configuration:', {
  NODE_ENV: process.env.NODE_ENV,
  CORS_ORIGIN: process.env.CORS_ORIGIN,
  'All environment vars': {
    PORT: process.env.PORT,
    NODE_ENV: process.env.NODE_ENV,
    CORS_ORIGIN: process.env.CORS_ORIGIN
  }
});

// Define isDevelopment - THIS WAS MISSING
const isDevelopment = process.env.NODE_ENV === 'development' || process.env.PORT === '5004';

// Always allow localhost in development regardless of NODE_ENV
const corsOriginStr = process.env.CORS_ORIGIN || '';
const baseOrigins = corsOriginStr.split(',').map(o => o.trim()).filter(Boolean);

const allowedOrigins = isDevelopment
  ? [...baseOrigins, 'http://localhost:3000', 'http://localhost:5003', 'http://localhost:1222']

========================================
COMPLETE!
Report saved to: hrms-detailed-diagnostic-20251206-115412.txt
========================================
